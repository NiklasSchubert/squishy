{% extends 'base.html' %}

{% block title %}Edit Profile - Squishy{% endblock %}

{% block content %}
<div class="profile-form">
    <div class="back-button-container">
        <a href="{{ url_for('admin.list_profiles') }}" class="button back-button">‚Üê Back to Profiles</a>
    </div>

    <h1>Edit Profile: {{ profile.name }}</h1>

    <form method="post">
        <div class="form-group">
            <label for="resolution">Resolution</label>
            <select id="resolution" name="resolution" required>
                <option value="3840x2160" {% if profile.resolution == "3840x2160" %}selected{% endif %}>4K (3840x2160)</option>
                <option value="1920x1080" {% if profile.resolution == "1920x1080" %}selected{% endif %}>1080p (1920x1080)</option>
                <option value="1280x720" {% if profile.resolution == "1280x720" %}selected{% endif %}>720p (1280x720)</option>
                <option value="854x480" {% if profile.resolution == "854x480" %}selected{% endif %}>480p (854x480)</option>
                <option value="640x360" {% if profile.resolution == "640x360" %}selected{% endif %}>360p (640x360)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="codec">Codec</label>
            <select id="codec" name="codec" required>
                <option value="h264" {% if profile.codec == "h264" %}selected{% endif %}>H.264 (AVC)</option>
                <option value="hevc" {% if profile.codec == "hevc" %}selected{% endif %}>H.265 (HEVC)</option>
                <option value="av1" {% if profile.codec == "av1" %}selected{% endif %}>AV1</option>
            </select>
        </div>

        <div class="form-group">
            <label for="container">Container</label>
            <select id="container" name="container" required>
                <option value="mkv" {% if profile.container == "mkv" %}selected{% endif %}>MKV</option>
                <option value="mp4" {% if profile.container == "mp4" %}selected{% endif %}>MP4</option>
            </select>
        </div>

        <div class="form-group">
            <label for="quality">Quality</label>
            <select id="quality" name="quality" required>
                <option value="high" {% if profile.quality == "high" %}selected{% endif %}>High</option>
                <option value="medium" {% if profile.quality == "medium" %}selected{% endif %}>Medium</option>
                <option value="low" {% if profile.quality == "low" %}selected{% endif %}>Low</option>
            </select>
        </div>

        <div class="form-group">
            <label for="bitrate">Bitrate (optional)</label>
            <input type="text" id="bitrate" name="bitrate" value="{{ profile.bitrate or '' }}" placeholder="e.g. 5M">
        </div>
        
        <div class="form-group">
            <label for="hw_accel">Hardware Acceleration</label>
            <select id="hw_accel" name="hw_accel">
                <option value="inherit" {% if profile.hw_accel == "inherit" or profile.hw_accel is none %}selected{% endif %}>Inherit Default</option>
                <option value="" {% if profile.hw_accel == "" %}selected{% endif %}>None (Software Encoding)</option>
                <option value="nvenc" {% if profile.hw_accel == "nvenc" %}selected{% endif %}>NVIDIA NVENC</option>
                <option value="qsv" {% if profile.hw_accel == "qsv" %}selected{% endif %}>Intel QuickSync (QSV)</option>
                <option value="vaapi" {% if profile.hw_accel == "vaapi" %}selected{% endif %}>VAAPI (Intel/AMD GPU)</option>
                <option value="videotoolbox" {% if profile.hw_accel == "videotoolbox" %}selected{% endif %}>VideoToolbox (macOS)</option>
                <option value="amf" {% if profile.hw_accel == "amf" %}selected{% endif %}>AMD AMF</option>
            </select>
            <p class="help-text">Select a hardware acceleration method to speed up transcoding. "Inherit Default" will use the global hardware acceleration settings.</p>
        </div>
        
        <div class="form-group" id="hw_device_group" {% if profile.hw_accel not in ["nvenc", "cuda", "vaapi"] %}style="display:none"{% endif %}>
            <label for="hw_device">Hardware Device</label>
            <input type="text" id="hw_device" name="hw_device" value="{{ profile.hw_device or '' }}" placeholder="e.g. /dev/dri/renderD128 or 0">
            <p class="help-text">For CUDA/NVENC: GPU index (e.g. "0"). For VAAPI: device path (e.g. "/dev/dri/renderD128").</p>
        </div>
        
        <div class="form-group" id="hw_failover_group" {% if profile.hw_accel == "" %}style="display:none"{% endif %}>
            <div class="checkbox-group">
                <input type="checkbox" id="allow_hw_failover" name="allow_hw_failover" {% if profile.allow_hw_failover %}checked{% endif %}>
                <label for="allow_hw_failover">Allow Fallback to Software Encoding</label>
            </div>
            <p class="help-text">If enabled, jobs will automatically fall back to software encoding when hardware acceleration fails. If disabled, jobs will fail when hardware acceleration encounters an error.</p>
        </div>

        <div class="form-actions">
            <button type="submit" class="button">Update Profile</button>
            <a href="{{ url_for('admin.list_profiles') }}" class="button secondary">Cancel</a>
        </div>
        
<script>
document.addEventListener('DOMContentLoaded', function() {
    const hwAccelSelect = document.getElementById('hw_accel');
    const hwDeviceGroup = document.getElementById('hw_device_group');
    const hwFailoverGroup = document.getElementById('hw_failover_group');
    
    hwAccelSelect.addEventListener('change', function() {
        // Show device field only for methods that need it
        if (this.value === 'nvenc' || this.value === 'cuda' || this.value === 'vaapi') {
            hwDeviceGroup.style.display = 'block';
        } else {
            hwDeviceGroup.style.display = 'none';
            // Clear the device input if not using a supported method
            if (this.value === 'inherit' || this.value === '') {
                document.getElementById('hw_device').value = '';
            }
        }
        
        // Show failover option only when hardware acceleration is enabled or inherited
        if (this.value === '') {
            hwFailoverGroup.style.display = 'none';
        } else {
            hwFailoverGroup.style.display = 'block';
        }
    });
});
</script>
    </form>
</div>
{% endblock %}
